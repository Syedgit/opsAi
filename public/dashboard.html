<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>opsAi Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .store-selector {
            margin-top: 15px;
        }
        
        .store-selector select {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            background: white;
            color: #333;
            cursor: pointer;
        }
        
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #25D366;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }
        
        .nav-tab:hover {
            background: #f0f0f0;
        }
        
        .nav-tab.active {
            background: #25D366;
            color: white;
        }
        
        .content-area {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 400px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-pending {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“Š opsAi Dashboard</h1>
        <div class="store-selector">
            <select id="storeSelect">
                <option value="">Select Store...</option>
            </select>
        </div>
    </div>
    
    <div class="container">
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>Today's Sales</h3>
                <div class="value" id="todaySales">-</div>
            </div>
            <div class="stat-card">
                <h3>Today's Invoices</h3>
                <div class="value" id="todayInvoices">-</div>
            </div>
            <div class="stat-card">
                <h3>Today's Orders</h3>
                <div class="value" id="todayOrders">-</div>
            </div>
            <div class="stat-card">
                <h3>Pending Actions</h3>
                <div class="value" id="pendingCount">-</div>
            </div>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="sales">Daily Sales</button>
            <button class="nav-tab" data-tab="invoices">Invoices & Expenses</button>
            <button class="nav-tab" data-tab="fuel">Fuel Sales</button>
            <button class="nav-tab" data-tab="paidouts">Paid Outs</button>
            <button class="nav-tab" data-tab="orders">Orders</button>
        </div>
        
        <div class="content-area" id="contentArea">
            <div class="loading">Select a store to view data...</div>
        </div>
    </div>

    <script>
        let currentStoreId = '';
        let currentTab = 'sales';

        // Load stores on page load
        async function loadStores() {
            try {
                const response = await fetch('/api/stores');
                const data = await response.json();
                const select = document.getElementById('storeSelect');
                
                data.stores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store.storeId;
                    option.textContent = `${store.storeId} - ${store.storeName}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading stores:', error);
            }
        }

        // Load dashboard stats
        async function loadDashboard(storeId) {
            try {
                const response = await fetch(`/api/stores/dashboard?storeId=${storeId}`);
                const data = await response.json();
                
                document.getElementById('todaySales').textContent = data.today.sales;
                document.getElementById('todayInvoices').textContent = data.today.invoices;
                document.getElementById('todayOrders').textContent = data.today.orders;
                document.getElementById('pendingCount').textContent = data.pending;
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Load data for current tab
        async function loadTabData(storeId, tab) {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = '<div class="loading">Loading...</div>';

            try {
                const response = await fetch(`/api/stores/data?storeId=${storeId}&type=${tab}`);
                const data = await response.json();
                const items = data[tab] || [];

                if (items.length === 0) {
                    contentArea.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ“­</div>
                            <h3>No ${tab} data found</h3>
                            <p>Data will appear here once messages are processed via WhatsApp</p>
                        </div>
                    `;
                    return;
                }

                // Render table based on tab type
                let tableHTML = '<table class="data-table"><thead><tr>';
                
                if (tab === 'sales') {
                    tableHTML += '<th>Date</th><th>Cash</th><th>Card</th><th>Tax</th><th>Total</th></tr></thead><tbody>';
                    items.forEach(item => {
                        const d = item.data || {};
                        tableHTML += `
                            <tr>
                                <td>${new Date(item.date).toLocaleDateString()}</td>
                                <td>$${d.cash || 0}</td>
                                <td>$${d.card || 0}</td>
                                <td>$${d.tax || 0}</td>
                                <td><strong>$${d.total_inside || 0}</strong></td>
                            </tr>
                        `;
                    });
                } else if (tab === 'invoices') {
                    tableHTML += '<th>Date</th><th>Vendor</th><th>Amount</th><th>Category</th><th>Paid</th></tr></thead><tbody>';
                    items.forEach(item => {
                        const d = item.data || {};
                        tableHTML += `
                            <tr>
                                <td>${new Date(item.date).toLocaleDateString()}</td>
                                <td>${d.vendor || 'N/A'}</td>
                                <td>$${d.amount || 0}</td>
                                <td>${d.category || 'N/A'}</td>
                                <td><span class="badge ${d.paid === 'Y' ? 'badge-success' : 'badge-pending'}">${d.paid || 'N'}</span></td>
                            </tr>
                        `;
                    });
                } else if (tab === 'fuel') {
                    tableHTML += '<th>Date</th><th>Gallons</th><th>Sales</th><th>GP</th></tr></thead><tbody>';
                    items.forEach(item => {
                        const d = item.data || {};
                        tableHTML += `
                            <tr>
                                <td>${new Date(item.date).toLocaleDateString()}</td>
                                <td>${d.gallons || 0}</td>
                                <td>$${d.fuel_sales || 0}</td>
                                <td>$${d.fuel_gp || 0}</td>
                            </tr>
                        `;
                    });
                } else if (tab === 'paidouts') {
                    tableHTML += '<th>Date</th><th>Amount</th><th>Reason</th><th>Employee</th></tr></thead><tbody>';
                    items.forEach(item => {
                        const d = item.data || {};
                        tableHTML += `
                            <tr>
                                <td>${new Date(item.date).toLocaleDateString()}</td>
                                <td>$${d.amount || 0}</td>
                                <td>${d.reason || 'N/A'}</td>
                                <td>${d.employee || 'N/A'}</td>
                            </tr>
                        `;
                    });
                } else if (tab === 'orders') {
                    tableHTML += '<th>Date</th><th>Order ID</th><th>Vendors</th><th>Items</th></tr></thead><tbody>';
                    items.forEach(item => {
                        const d = item.data || {};
                        const vendors = d.vendor_groups || [];
                        const itemCount = vendors.reduce((sum, v) => sum + (v.items?.length || 0), 0);
                        tableHTML += `
                            <tr>
                                <td>${new Date(item.date).toLocaleDateString()}</td>
                                <td>${d.order_batch_id || 'N/A'}</td>
                                <td>${vendors.length}</td>
                                <td>${itemCount}</td>
                            </tr>
                        `;
                    });
                }

                tableHTML += '</tbody></table>';
                contentArea.innerHTML = tableHTML;
            } catch (error) {
                console.error('Error loading data:', error);
                contentArea.innerHTML = '<div class="empty-state">Error loading data. Please try again.</div>';
            }
        }

        // Store selector change
        document.getElementById('storeSelect').addEventListener('change', (e) => {
            currentStoreId = e.target.value;
            if (currentStoreId) {
                loadDashboard(currentStoreId);
                loadTabData(currentStoreId, currentTab);
            } else {
                document.getElementById('contentArea').innerHTML = '<div class="loading">Select a store to view data...</div>';
            }
        });

        // Tab switching
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTab = tab.dataset.tab;
                if (currentStoreId) {
                    loadTabData(currentStoreId, currentTab);
                }
            });
        });

        // Initialize
        loadStores();
    </script>
</body>
</html>
